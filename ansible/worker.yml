---
- name: Configure SQS order worker
  hosts: localhost
  connection: local
  become: true
  vars:
    app_dir: /opt/order-worker
  tasks:
    - name: Install runtime packages
      package:
        name:
          - python3
          - python3-pip
        state: present

    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Copy worker script
      copy:
        src: ../app/worker.py
        dest: "{{ app_dir }}/worker.py"
        owner: root
        group: root
        mode: "0755"

    - name: Copy requirements
      copy:
        src: ../app/requirements.txt
        dest: "{{ app_dir }}/requirements.txt"
        owner: root
        group: root
        mode: "0644"

    - name: Install Python dependencies
      pip:
        requirements: "{{ app_dir }}/requirements.txt"
        executable: pip3

    - name: Write worker environment file
      copy:
        dest: /etc/order-worker.env
        owner: root
        group: root
        mode: "0644"
        content: |
          AWS_REGION={{ aws_region }}
          QUEUE_URL={{ queue_url }}
          DDB_TABLE={{ ddb_table }}

    - name: Install systemd unit
      copy:
        dest: /etc/systemd/system/order-worker.service
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=FIFO Order Processor Worker
          After=network-online.target

          [Service]
          Type=simple
          EnvironmentFile=/etc/order-worker.env
          ExecStart=/usr/bin/python3 {{ app_dir }}/worker.py
          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target

    - name: Enable and restart service
      systemd:
        name: order-worker
        enabled: true
        daemon_reload: true
        state: restarted
